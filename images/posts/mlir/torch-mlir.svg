<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="4643px" preserveAspectRatio="none" style="width:3243px;height:4643px;background:#FFFFFF;" version="1.1" viewBox="0 0 3243 4643" width="3243px" zoomAndPan="magnify"><defs/><g><rect fill="#E0E0E0" height="450.6357" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="232.6865"/><rect fill="#E0E0E0" height="619.2715" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="768.7969"/><rect fill="#E0E0E0" height="581.6909" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="1460.1743"/><rect fill="#E0E0E0" height="961.5342" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="2167.4458"/><rect fill="#E0E0E0" height="1253.2759" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="3294.6665"/><rect fill="#E0E0E0" height="395.8984" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="890.5" y="260.0552"/><rect fill="#E0E0E0" height="509.7969" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="890.5" y="823.5342"/><rect fill="#E0E0E0" height="327.7925" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1254.5" y="300.7925"/><rect fill="#E0E0E0" height="401.585" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1254.5" y="904.3774"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="341.5298"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2262.5518"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2317.2891"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2412.395"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2507.501"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2562.2383"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2616.9756"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2671.7129"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2726.4502"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2781.1875"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2835.9248"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2890.6621"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2945.3994"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="3000.1367"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="409.6357"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="3349.4038"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="4356.3618"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="4411.0991"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="4465.8364"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="464.373"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="3404.1411"/><rect fill="#E0E0E0" height="585.7969" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="3458.8784"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="4072.0439"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="4126.7813"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2100" y="519.1104"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2239" y="573.8477"/><rect fill="#E0E0E0" height="564.5342" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2384" y="796.1655"/><rect fill="#E0E0E0" height="513.585" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2384" y="1500.9116"/><rect fill="#E0E0E0" height="412.1104" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2521" y="1575.0176"/><rect fill="#E0E0E0" height="182.3179" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2810" y="1777.4414"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="3008" y="1655.8608"/><rect fill="#E0E0E0" height="100.8433" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="3008" y="1831.5474"/><rect fill="#E0E0E0" height="906.7969" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="3008" y="2194.8145"/><rect fill="#E0E0E0" height="1198.5386" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="3008" y="3322.0352"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="254" x2="254" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="683.5" x2="683.5" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="895.5" x2="895.5" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1259" x2="1259" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1508" x2="1508" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1639" x2="1639" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1765" x2="1765" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2105" x2="2105" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2244" x2="2244" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2389" x2="2389" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2526" x2="2526" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2815" x2="2815" y1="78.3687" y2="4565.9424"/><line style="stroke:#2A86E2;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="3013" x2="3013" y1="78.3687" y2="4565.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="39" x="232" y="76.0591">Python</text><ellipse cx="254.5" cy="13.5" fill="#2A86E2" rx="8" ry="8" style="stroke:#1A66C2;stroke-width:0.5;"/><path d="M254.5,21.5 L254.5,48.5 M241.5,29.5 L267.5,29.5 M254.5,48.5 L241.5,63.5 M254.5,48.5 L267.5,63.5 " fill="none" style="stroke:#1A66C2;stroke-width:0.5;"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="39" x="232" y="4576.0015">Python</text><ellipse cx="254.5" cy="4586.811" fill="#2A86E2" rx="8" ry="8" style="stroke:#1A66C2;stroke-width:0.5;"/><path d="M254.5,4594.811 L254.5,4621.811 M241.5,4602.811 L267.5,4602.811 M254.5,4621.811 L241.5,4636.811 M254.5,4621.811 L267.5,4636.811 " fill="none" style="stroke:#1A66C2;stroke-width:0.5;"/><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="66" x="650.5" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="52" x="657.5" y="68.0591">pybind11</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="66" x="650.5" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="52" x="657.5" y="4583.0015">pybind11</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="42" x="874.5" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="28" x="881.5" y="68.0591">CAPI</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="42" x="874.5" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="28" x="881.5" y="4583.0015">CAPI</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="47" x="1236" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="33" x="1243" y="68.0591">InitAll</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="47" x="1236" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="33" x="1243" y="4583.0015">InitAll</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="89" x="1464" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="75" x="1471" y="68.0591">Dialect/Torch</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="89" x="1464" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="75" x="1471" y="4583.0015">Dialect/Torch</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="153" x="1563" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="139" x="1570" y="68.0591">Dialect/TorchConversion</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="153" x="1563" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="139" x="1570" y="4583.0015">Dialect/TorchConversion</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="78" x="1726" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="64" x="1733" y="68.0591">Conversion</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="78" x="1726" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="64" x="1733" y="4583.0015">Conversion</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="82" x="2064" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="68" x="2071" y="68.0591">RefBackend</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="82" x="2064" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="68" x="2071" y="4583.0015">RefBackend</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="176" x="2156" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="162" x="2163" y="68.0591">externals/torch-mlir-dialects</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="176" x="2156" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="162" x="2163" y="4583.0015">externals/torch-mlir-dialects</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="94" x="2342" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="80" x="2349" y="68.0591">ModuleBuilder</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="94" x="2342" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="80" x="2349" y="4583.0015">ModuleBuilder</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="102" x="2475" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="88" x="2482" y="68.0591">IValueImporter</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="102" x="2475" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="88" x="2482" y="4583.0015">IValueImporter</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="94" x="2768" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="80" x="2775" y="68.0591">NodeImporter</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="94" x="2768" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="80" x="2775" y="4583.0015">NodeImporter</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="42" x="2992" y="50"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="28" x="2999" y="68.0591">MLIR</text><rect fill="#CCCCCC" height="27.3687" rx="2.5" ry="2.5" style="stroke:#AAAAAA;stroke-width:0.5;" width="42" x="2992" y="4564.9424"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="28" x="2999" y="4583.0015">MLIR</text><rect fill="#E0E0E0" height="450.6357" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="232.6865"/><rect fill="#E0E0E0" height="619.2715" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="768.7969"/><rect fill="#E0E0E0" height="581.6909" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="1460.1743"/><rect fill="#E0E0E0" height="961.5342" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="2167.4458"/><rect fill="#E0E0E0" height="1253.2759" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="678.5" y="3294.6665"/><rect fill="#E0E0E0" height="395.8984" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="890.5" y="260.0552"/><rect fill="#E0E0E0" height="509.7969" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="890.5" y="823.5342"/><rect fill="#E0E0E0" height="327.7925" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1254.5" y="300.7925"/><rect fill="#E0E0E0" height="401.585" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1254.5" y="904.3774"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="341.5298"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2262.5518"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2317.2891"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2412.395"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2507.501"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2562.2383"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2616.9756"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2671.7129"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2726.4502"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2781.1875"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2835.9248"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2890.6621"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="2945.3994"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1503.5" y="3000.1367"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="409.6357"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="3349.4038"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="4356.3618"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="4411.0991"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1634.5" y="4465.8364"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="464.373"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="3404.1411"/><rect fill="#E0E0E0" height="585.7969" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="3458.8784"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="4072.0439"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="1760" y="4126.7813"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2100" y="519.1104"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2239" y="573.8477"/><rect fill="#E0E0E0" height="564.5342" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2384" y="796.1655"/><rect fill="#E0E0E0" height="513.585" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2384" y="1500.9116"/><rect fill="#E0E0E0" height="412.1104" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2521" y="1575.0176"/><rect fill="#E0E0E0" height="182.3179" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="2810" y="1777.4414"/><rect fill="#E0E0E0" height="27.3687" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="3008" y="1655.8608"/><rect fill="#E0E0E0" height="100.8433" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="3008" y="1831.5474"/><rect fill="#E0E0E0" height="906.7969" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="3008" y="2194.8145"/><rect fill="#E0E0E0" height="1198.5386" style="stroke:#2A86E2;stroke-width:1.0;" width="10" x="3008" y="3322.0352"/><rect fill="#2A86E2" height="114" style="stroke:#181818;stroke-width:0.5;" width="374" x="67" y="93.3687"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="219" x="71" y="108.4277">1. 注册与torch相关的MLIR转换和优化Pass</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="70" x="71" y="121.7964">import torch</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="99" x="71" y="135.165">import torch_mlir</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="206" x="71" y="148.5337">class TanhModule(torch.nn.Module):</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="116" x="79" y="161.9023">def forward(self, a):</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="114" x="95" y="175.271">return torch.tanh(a)</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="346" x="71" y="188.6396">compiled = torch_mlir.compile(TanhModule(), torch.ones(3),</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="342" x="95" y="202.0083">output_type=torch_mlir.OutputType.LINALG_ON_TENSORS)</text><polygon fill="#000000" points="666.5,228.6865,676.5,232.6865,666.5,236.6865,670.5,232.6865" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="254.5" x2="672.5" y1="232.6865" y2="232.6865"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="261.5" y="228.377">1.1</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="196" x="285.5" y="228.377">PYBIND11_MODULE(_torchMlir, m)</text><polygon fill="#000000" points="878.5,256.0552,888.5,260.0552,878.5,264.0552,882.5,260.0552" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="688.5" x2="884.5" y1="260.0552" y2="260.0552"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="695.5" y="255.7456">1.2</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="159" x="719.5" y="255.7456">torchMlirRegisterAllPasses()</text><polygon fill="#000000" points="1242.5,296.7925,1252.5,300.7925,1242.5,304.7925,1246.5,300.7925" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="900.5" x2="1248.5" y1="300.7925" y2="300.7925"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="907.5" y="289.7986">1.3</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="178" x="931.5" y="283.1143">mlir::torch::registerAllPasses()</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="204" x="931.5" y="296.4829">注册与torch相关的MLIR转换和优化Pass</text><polygon fill="#000000" points="1491.5,337.5298,1501.5,341.5298,1491.5,345.5298,1495.5,341.5298" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1264.5" x2="1497.5" y1="341.5298" y2="341.5298"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1271.5" y="330.5359">1.4</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="196" x="1295.5" y="323.8516">mlir::torch::registerTorchPasses()</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="168" x="1295.5" y="337.2202">注册优化TorchDialect IR的Pass</text><polygon fill="#000000" points="1275.5,364.8984,1265.5,368.8984,1275.5,372.8984,1271.5,368.8984" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1269.5" x2="1507.5" y1="368.8984" y2="368.8984"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1281.5" y="364.5889">1.5</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1305.5" y="364.5889"> </text><polygon fill="#000000" points="1622.5,405.6357,1632.5,409.6357,1622.5,413.6357,1626.5,409.6357" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1264.5" x2="1628.5" y1="409.6357" y2="409.6357"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1271.5" y="398.6418">1.6</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="260" x="1295.5" y="391.9575">mlir::torch::registerTorchConversionPasses()</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="271" x="1295.5" y="405.3262">注册把TorchDialect Convert为LinalgDialect的Pass</text><polygon fill="#000000" points="1275.5,433.0044,1265.5,437.0044,1275.5,441.0044,1271.5,437.0044" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1269.5" x2="1638.5" y1="437.0044" y2="437.0044"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1281.5" y="432.6948">1.7</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1305.5" y="432.6948"> </text><polygon fill="#000000" points="1748,460.373,1758,464.373,1748,468.373,1752,464.373" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1264.5" x2="1754" y1="464.373" y2="464.373"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1271.5" y="460.0635">1.8</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="228" x="1295.5" y="460.0635">mlir::torch::registerConversionPasses()</text><polygon fill="#000000" points="1275.5,487.7417,1265.5,491.7417,1275.5,495.7417,1271.5,491.7417" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1269.5" x2="1764" y1="491.7417" y2="491.7417"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1281.5" y="487.4321">1.9</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1305.5" y="487.4321"> </text><polygon fill="#000000" points="2088,515.1104,2098,519.1104,2088,523.1104,2092,519.1104" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1264.5" x2="2094" y1="519.1104" y2="519.1104"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1271.5" y="514.8008">1.10</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="310" x="1303.5" y="514.8008">mlir::torch::RefBackend::registerRefBackendPasses()</text><polygon fill="#000000" points="1275.5,542.479,1265.5,546.479,1275.5,550.479,1271.5,546.479" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1269.5" x2="2104" y1="546.479" y2="546.479"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1281.5" y="542.1694">1.11</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1313.5" y="542.1694"> </text><polygon fill="#000000" points="2227,569.8477,2237,573.8477,2227,577.8477,2231,573.8477" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1264.5" x2="2233" y1="573.8477" y2="573.8477"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1271.5" y="569.5381">1.12</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="229" x="1303.5" y="569.5381">mlir::torch::TMTensor::registerPasses()</text><polygon fill="#000000" points="1275.5,597.2163,1265.5,601.2163,1275.5,605.2163,1271.5,601.2163" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1269.5" x2="2243" y1="601.2163" y2="601.2163"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1281.5" y="596.9067">1.13</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1313.5" y="596.9067"> </text><polygon fill="#000000" points="911.5,624.585,901.5,628.585,911.5,632.585,907.5,628.585" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="905.5" x2="1258.5" y1="628.585" y2="628.585"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="917.5" y="624.2754">1.14</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="949.5" y="624.2754"> </text><polygon fill="#000000" points="699.5,651.9536,689.5,655.9536,699.5,659.9536,695.5,655.9536" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="693.5" x2="894.5" y1="655.9536" y2="655.9536"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="705.5" y="651.644">1.15</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="737.5" y="651.644"> </text><polygon fill="#000000" points="265.5,679.3223,255.5,683.3223,265.5,687.3223,261.5,683.3223" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="259.5" x2="682.5" y1="683.3223" y2="683.3223"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="271.5" y="679.0127">1.16</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="303.5" y="679.0127"> </text><rect fill="#2A86E2" height="48" style="stroke:#181818;stroke-width:0.5;" width="385" x="62" y="696.3223"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="203" x="66" y="711.3813">2. 注册torch-mlir使用到的所有Dialects</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="377" x="66" y="724.75">from torch_mlir.dialects.torch.importer.jit_ir import ModuleBuilder</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="325" x="66" y="738.1187">mb = ModuleBuilder() # 节选自torch_mlir.compile函数定义</text><polygon fill="#000000" points="666.5,764.7969,676.5,768.7969,666.5,772.7969,670.5,768.7969" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="254.5" x2="672.5" y1="768.7969" y2="768.7969"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="261.5" y="764.4873">2.1</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="285.5" y="764.4873"> </text><polygon fill="#000000" points="2372,792.1655,2382,796.1655,2372,800.1655,2376,796.1655" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="688.5" x2="2378" y1="796.1655" y2="796.1655"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="695.5" y="791.856">2.2</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="146" x="719.5" y="791.856">创建ModuleBuilder类型对象</text><polygon fill="#000000" points="911.5,819.5342,901.5,823.5342,911.5,827.5342,907.5,823.5342" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="905.5" x2="2383" y1="823.5342" y2="823.5342"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="917.5" y="819.2246">2.3</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="206" x="941.5" y="819.2246">torchMlirRegisterAllDialects(context)</text><polygon fill="#000000" points="1242.5,900.3774,1252.5,904.3774,1242.5,908.3774,1246.5,904.3774" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="900.5" x2="1248.5" y1="904.3774" y2="904.3774"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="907.5" y="873.3306">2.4</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="227" x="931.5" y="846.5933">mlir::torch::registerAllDialects(registry)</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="99" x="931.5" y="859.9619">注册如下Dialects：</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="183" x="931.5" y="873.3306">mlir::torch::Torch::TorchDialect</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="311" x="931.5" y="886.6992">mlir::torch::TorchConversion::TorchConversionDialect</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="229" x="931.5" y="900.0679">mlir::torch::TMTensor::TMTensorDialect</text><path d="M1513,917.3774 L1513,1221.3774 L2019,1221.3774 L2019,927.3774 L2009,917.3774 L1513,917.3774 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><path d="M2009,917.3774 L2009,927.3774 L2019,927.3774 L2009,917.3774 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="285" x="1519" y="933.4365">def Torch_AtenTanhOp : Torch_Op&lt;"aten.tanh", [</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="133" x="1535" y="946.8052">AllowsTypeRefinement,</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="116" x="1535" y="960.1738">HasValueSemantics,</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="55" x="1535" y="973.5425">ReadOnly</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="25" x="1527" y="986.9111">]&gt; {</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="413" x="1527" y="1000.2798">let summary = "Generated op for `aten::tanh : (Tensor) -&gt; (Tensor)`";</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="117" x="1527" y="1013.6484">let arguments = (ins</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="153" x="1535" y="1027.0171">AnyTorchTensorType:$self</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="10" x="1527" y="1040.3857">);</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="102" x="1527" y="1053.7544">let results = (outs</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="165" x="1535" y="1067.123">AnyTorchTensorType:$result</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="10" x="1527" y="1080.4917">);</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="205" x="1527" y="1093.8604">let hasCustomAssemblyFormat = 1;</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="160" x="1527" y="1107.229">let extraClassDefinition = [{</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="469" x="1535" y="1120.5977">ParseResult AtenTanhOp::parse(OpAsmParser &amp;parser, OperationState &amp;result) {</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="281" x="1543" y="1133.9663">return parseDefaultTorchOp(parser, result, 1, 1);</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="7" x="1535" y="1147.335">}</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="284" x="1535" y="1160.7036">void AtenTanhOp::print(OpAsmPrinter &amp;printer) {</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="232" x="1543" y="1174.0723">printDefaultTorchOp(printer, *this, 1, 1);</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="7" x="1535" y="1187.4409">}</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="17" x="1527" y="1200.8096">}];</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="7" x="1519" y="1214.1782">}</text><path d="M1269,1231.4878 L1269,1281.4878 L1619,1281.4878 L1619,1241.4878 L1609,1231.4878 L1269,1231.4878 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><path d="M1609,1231.4878 L1609,1241.4878 L1619,1241.4878 L1609,1231.4878 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="329" x="1275" y="1247.5469">注册TorchDialect/TorchConversionDialect/TMTensorDialect</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="309" x="1275" y="1260.9155">TorchDialect中的Op定义已经通过torch_ods_gen.py生成到</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="162" x="1275" y="1274.2842">GeneratedTorchOps.td文件中</text><polygon fill="#000000" points="911.5,1301.9624,901.5,1305.9624,911.5,1309.9624,907.5,1305.9624" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="905.5" x2="1258.5" y1="1305.9624" y2="1305.9624"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="917.5" y="1301.6528">2.5</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="941.5" y="1301.6528"> </text><polygon fill="#000000" points="2372,1329.3311,2382,1333.3311,2372,1337.3311,2376,1333.3311" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="895.5" x2="2378" y1="1333.3311" y2="1333.3311"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="902.5" y="1329.0215">2.6</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="926.5" y="1329.0215"> </text><polygon fill="#000000" points="699.5,1356.6997,689.5,1360.6997,699.5,1364.6997,695.5,1360.6997" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="693.5" x2="2388" y1="1360.6997" y2="1360.6997"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="705.5" y="1356.3901">2.7</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="729.5" y="1356.3901"> </text><polygon fill="#000000" points="265.5,1384.0684,255.5,1388.0684,265.5,1392.0684,261.5,1388.0684" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="259.5" x2="682.5" y1="1388.0684" y2="1388.0684"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="271.5" y="1383.7588">2.8</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="295.5" y="1383.7588"> </text><rect fill="#2A86E2" height="34" style="stroke:#181818;stroke-width:0.5;" width="486" x="11" y="1401.0684"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="223" x="15" y="1416.1274">3. 将torchscript IR转换为TorchDialect IR</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="478" x="15" y="1429.4961">mb.import_module(scripted._c, class_annotator) # 节选自torch_mlir.compile函数定义</text><polygon fill="#000000" points="666.5,1456.1743,676.5,1460.1743,666.5,1464.1743,670.5,1460.1743" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="254.5" x2="672.5" y1="1460.1743" y2="1460.1743"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="261.5" y="1455.8647">3.1</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="96" x="285.5" y="1455.8647">import_module()</text><polygon fill="#000000" points="2372,1496.9116,2382,1500.9116,2372,1504.9116,2376,1500.9116" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="688.5" x2="2378" y1="1500.9116" y2="1500.9116"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="695.5" y="1489.9177">3.2</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="87" x="719.5" y="1483.2334">importModule()</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="255" x="719.5" y="1496.6021">变量torchscript IR并创建对应的TorchDialect Op</text><path d="M2399,1513.9116 L2399,1549.9116 L2688,1549.9116 L2688,1523.9116 L2678,1513.9116 L2399,1513.9116 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><path d="M2678,1513.9116 L2678,1523.9116 L2688,1523.9116 L2678,1513.9116 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="143" x="2405" y="1529.9707">举例，torchscript IR节点：</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="268" x="2405" y="1543.3394">%1: Float(3:4, 4:1) = aten::mm(%4, %2, %3)</text><polygon fill="#000000" points="2509,1571.0176,2519,1575.0176,2509,1579.0176,2513,1575.0176" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="2394" x2="2515" y1="1575.0176" y2="1575.0176"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="2401" y="1570.708">3.3</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="84" x="2425" y="1570.708">importIValue()</text><polygon fill="#000000" points="2996,1651.8608,3006,1655.8608,2996,1659.8608,3000,1655.8608" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="2531" x2="3002" y1="1655.8608" y2="1655.8608"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="2538" y="1624.814">3.4</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="194" x="2562" y="1598.0767">IValueImporter::importIValue调用</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="206" x="2562" y="1611.4453">IValueImporter::rawImportIValue，</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="167" x="2562" y="1624.814">接着调用createMlirOperation和</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="145" x="2562" y="1638.1826">createMlirOperationAtEnd</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="156" x="2562" y="1651.5513">以创建对应的TorchDialect Op</text><polygon fill="#000000" points="2542,1679.2295,2532,1683.2295,2542,1687.2295,2538,1683.2295" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2536" x2="3012" y1="1683.2295" y2="1683.2295"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="2548" y="1678.9199">3.5</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="2572" y="1678.9199"> </text><polygon fill="#000000" points="2798,1773.4414,2808,1777.4414,2798,1781.4414,2802,1777.4414" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="2531" x2="2804" y1="1777.4414" y2="1777.4414"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="2538" y="1739.7102">3.6</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="194" x="2562" y="1706.2886">IValueImporter::importIValue调用</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="206" x="2562" y="1719.6572">IValueImporter::rawImportIValue，</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="230" x="2562" y="1733.0259">接着调用IValueImporter::importModule，</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="170" x="2562" y="1746.3945">再调用importCompilationUnit，</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="207" x="2562" y="1759.7632">接着调用importJitFunctionAsFuncOp，</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="236" x="2562" y="1773.1318">最后调用importBlock，即进入NodeImporter</text><polygon fill="#000000" points="2996,1827.5474,3006,1831.5474,2996,1835.5474,3000,1831.5474" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="2820" x2="3002" y1="1831.5474" y2="1831.5474"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="2827" y="1813.8691">3.7</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="145" x="2851" y="1800.5005">调用createMlirOperation和</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="145" x="2851" y="1813.8691">createMlirOperationAtEnd</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="145" x="2851" y="1827.2378">创建对应的TorchDialect Op</text><path d="M2825,1844.5474 L2825,1907.5474 L3154,1907.5474 L3154,1854.5474 L3144,1844.5474 L2825,1844.5474 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><path d="M3144,1844.5474 L3144,1854.5474 L3154,1854.5474 L3144,1844.5474 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="191" x="2831" y="1860.6064">转换为TorchDialect IR，对应的Op：</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="213" x="2831" y="1873.9751">%1 = torch.aten.mm %arg0, %arg1:</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="308" x="2831" y="1887.3438">!torch.vtensor&lt;[?,?], f32&gt;, !torch.vtensor&lt;[?,?], f32&gt;</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="169" x="2831" y="1900.7124">-&gt; !torch.vtensor&lt;[?,2], f32&gt;</text><polygon fill="#000000" points="2831,1928.3906,2821,1932.3906,2831,1936.3906,2827,1932.3906" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2825" x2="3012" y1="1932.3906" y2="1932.3906"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="2837" y="1928.0811">3.8</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="2861" y="1928.0811"> </text><polygon fill="#000000" points="2542,1955.7593,2532,1959.7593,2542,1963.7593,2538,1959.7593" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2536" x2="2814" y1="1959.7593" y2="1959.7593"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="2548" y="1955.4497">3.9</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="2572" y="1955.4497"> </text><polygon fill="#000000" points="2405,1983.1279,2395,1987.1279,2405,1991.1279,2401,1987.1279" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2399" x2="2525" y1="1987.1279" y2="1987.1279"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="2411" y="1982.8184">3.10</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="2443" y="1982.8184"> </text><polygon fill="#000000" points="699.5,2010.4966,689.5,2014.4966,699.5,2018.4966,695.5,2014.4966" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="693.5" x2="2388" y1="2014.4966" y2="2014.4966"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="705.5" y="2010.187">3.11</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="737.5" y="2010.187"> </text><polygon fill="#000000" points="265.5,2037.8652,255.5,2041.8652,265.5,2045.8652,261.5,2041.8652" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="259.5" x2="682.5" y1="2041.8652" y2="2041.8652"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="271.5" y="2037.5557">3.12</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="303.5" y="2037.5557"> </text><rect fill="#2A86E2" height="61" style="stroke:#181818;stroke-width:0.5;" width="500" x="5" y="2054.8652"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="291" x="9" y="2069.9243">4. 对TorchDialect IR执行各种Pass优化(即Transforms)</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="253" x="9" y="2083.293">run_pipeline_with_repro_report(mb.module,</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="273" x="25" y="2096.6616">"torchscript-module-to-torch-backend-pipeline",</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="476" x="25" y="2110.0303">"Lowering TorchScript IR -&gt; Torch Backend IR") # 节选自torch_mlir.compile函数定义</text><polygon fill="#000000" points="666.5,2163.4458,676.5,2167.4458,666.5,2171.4458,670.5,2167.4458" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="254.5" x2="672.5" y1="2167.4458" y2="2167.4458"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="261.5" y="2149.7676">4.1</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="381" x="285.5" y="2136.3989">def run_pipeline_with_repro_report(module, pipeline, description):</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="200" x="317.5" y="2149.7676">pm = PassManager.parse(pipeline)</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="93" x="317.5" y="2163.1362">pm.run(module)</text><polygon fill="#000000" points="2996,2190.8145,3006,2194.8145,2996,2198.8145,3000,2194.8145" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="688.5" x2="3002" y1="2194.8145" y2="2194.8145"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="695.5" y="2190.5049">4.2</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="227" x="719.5" y="2190.5049">mlir::PassManager::run(Operation *op)</text><line style="stroke:#000000;stroke-width:1.0;" x1="3018" x2="3060" y1="2222.1831" y2="2222.1831"/><line style="stroke:#000000;stroke-width:1.0;" x1="3060" x2="3060" y1="2222.1831" y2="2235.1831"/><line style="stroke:#000000;stroke-width:1.0;" x1="3019" x2="3060" y1="2235.1831" y2="2235.1831"/><polygon fill="#000000" points="3029,2231.1831,3019,2235.1831,3029,2239.1831,3025,2235.1831" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="3025" y="2217.8735">4.3</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="66" x="3049" y="2217.8735">SymbolDCE</text><polygon fill="#000000" points="1524.5,2258.5518,1514.5,2262.5518,1524.5,2266.5518,1520.5,2262.5518" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2262.5518" y2="2262.5518"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1530.5" y="2258.2422">4.4</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="187" x="1554.5" y="2258.2422">PrepareForGlobalizeObjectGraph</text><polygon fill="#000000" points="2996,2285.9204,3006,2289.9204,2996,2293.9204,3000,2289.9204" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2289.9204" y2="2289.9204"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1515.5" y="2285.6108">4.5</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1539.5" y="2285.6108"> </text><polygon fill="#000000" points="1524.5,2313.2891,1514.5,2317.2891,1524.5,2321.2891,1520.5,2317.2891" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2317.2891" y2="2317.2891"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1530.5" y="2312.9795">4.6</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="124" x="1554.5" y="2312.9795">GlobalizeObjectGraph</text><polygon fill="#000000" points="2996,2340.6577,3006,2344.6577,2996,2348.6577,3000,2344.6577" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2344.6577" y2="2344.6577"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1515.5" y="2340.3481">4.7</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1539.5" y="2340.3481"> </text><line style="stroke:#000000;stroke-width:1.0;" x1="3018" x2="3060" y1="2372.0264" y2="2372.0264"/><line style="stroke:#000000;stroke-width:1.0;" x1="3060" x2="3060" y1="2372.0264" y2="2385.0264"/><line style="stroke:#000000;stroke-width:1.0;" x1="3019" x2="3060" y1="2385.0264" y2="2385.0264"/><polygon fill="#000000" points="3029,2381.0264,3019,2385.0264,3029,2389.0264,3025,2385.0264" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="3025" y="2367.7168">4.8</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="37" x="3049" y="2367.7168">Inliner</text><polygon fill="#000000" points="1524.5,2408.395,1514.5,2412.395,1524.5,2416.395,1520.5,2412.395" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2412.395" y2="2412.395"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1530.5" y="2408.0854">4.9</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="144" x="1554.5" y="2408.0854">AdjustCallingConventions</text><polygon fill="#000000" points="2996,2435.7637,3006,2439.7637,2996,2443.7637,3000,2439.7637" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2439.7637" y2="2439.7637"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2435.4541">4.10</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2435.4541"> </text><line style="stroke:#000000;stroke-width:1.0;" x1="3018" x2="3060" y1="2467.1323" y2="2467.1323"/><line style="stroke:#000000;stroke-width:1.0;" x1="3060" x2="3060" y1="2467.1323" y2="2480.1323"/><line style="stroke:#000000;stroke-width:1.0;" x1="3019" x2="3060" y1="2480.1323" y2="2480.1323"/><polygon fill="#000000" points="3029,2476.1323,3019,2480.1323,3029,2484.1323,3025,2480.1323" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="3025" y="2462.8228">4.11</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="76" x="3057" y="2462.8228">Canonicalizer</text><polygon fill="#000000" points="1524.5,2503.501,1514.5,2507.501,1524.5,2511.501,1520.5,2507.501" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2507.501" y2="2507.501"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2503.1914">4.12</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="96" x="1562.5" y="2503.1914">InlineGlobalSlots</text><polygon fill="#000000" points="2996,2530.8696,3006,2534.8696,2996,2538.8696,3000,2534.8696" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2534.8696" y2="2534.8696"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2530.5601">4.13</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2530.5601"> </text><polygon fill="#000000" points="1524.5,2558.2383,1514.5,2562.2383,1524.5,2566.2383,1520.5,2562.2383" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2562.2383" y2="2562.2383"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2557.9287">4.14</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="105" x="1562.5" y="2557.9287">ReduceOpVariants</text><polygon fill="#000000" points="2996,2585.6069,3006,2589.6069,2996,2593.6069,3000,2589.6069" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2589.6069" y2="2589.6069"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2585.2974">4.15</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2585.2974"> </text><polygon fill="#000000" points="1524.5,2612.9756,1514.5,2616.9756,1524.5,2620.9756,1520.5,2616.9756" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2616.9756" y2="2616.9756"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2612.666">4.16</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="144" x="1562.5" y="2612.666">MaximizeValueSemantics</text><polygon fill="#000000" points="2996,2640.3442,3006,2644.3442,2996,2648.3442,3000,2644.3442" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2644.3442" y2="2644.3442"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2640.0347">4.17</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2640.0347"> </text><polygon fill="#000000" points="1524.5,2667.7129,1514.5,2671.7129,1524.5,2675.7129,1520.5,2671.7129" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2671.7129" y2="2671.7129"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2667.4033">4.18</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="107" x="1562.5" y="2667.4033">RefinePublicReturn</text><polygon fill="#000000" points="2996,2695.0815,3006,2699.0815,2996,2703.0815,3000,2699.0815" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2699.0815" y2="2699.0815"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2694.772">4.19</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2694.772"> </text><polygon fill="#000000" points="1524.5,2722.4502,1514.5,2726.4502,1524.5,2730.4502,1520.5,2726.4502" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2726.4502" y2="2726.4502"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2722.1406">4.20</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="203" x="1562.5" y="2722.1406">VerifyConversionToValueSemantics</text><polygon fill="#000000" points="2996,2749.8188,3006,2753.8188,2996,2757.8188,3000,2753.8188" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2753.8188" y2="2753.8188"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2749.5093">4.21</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2749.5093"> </text><polygon fill="#000000" points="1524.5,2777.1875,1514.5,2781.1875,1524.5,2785.1875,1520.5,2781.1875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2781.1875" y2="2781.1875"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2776.8779">4.22</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="133" x="1562.5" y="2776.8779">ReifyShapeCalculations</text><polygon fill="#000000" points="2996,2804.5562,3006,2808.5562,2996,2812.5562,3000,2808.5562" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2808.5562" y2="2808.5562"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2804.2466">4.23</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2804.2466"> </text><polygon fill="#000000" points="1524.5,2831.9248,1514.5,2835.9248,1524.5,2839.9248,1520.5,2835.9248" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2835.9248" y2="2835.9248"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2831.6152">4.24</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="150" x="1562.5" y="2831.6152">SimplifyShapeCalculations</text><polygon fill="#000000" points="2996,2859.2935,3006,2863.2935,2996,2867.2935,3000,2863.2935" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2863.2935" y2="2863.2935"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2858.9839">4.25</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2858.9839"> </text><polygon fill="#000000" points="1524.5,2886.6621,1514.5,2890.6621,1524.5,2894.6621,1520.5,2890.6621" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2890.6621" y2="2890.6621"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2886.3525">4.26</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="131" x="1562.5" y="2886.3525">DropShapeCalculations</text><polygon fill="#000000" points="2996,2914.0308,3006,2918.0308,2996,2922.0308,3000,2918.0308" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2918.0308" y2="2918.0308"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2913.7212">4.27</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2913.7212"> </text><polygon fill="#000000" points="1524.5,2941.3994,1514.5,2945.3994,1524.5,2949.3994,1520.5,2945.3994" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="2945.3994" y2="2945.3994"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2941.0898">4.28</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="70" x="1562.5" y="2941.0898">RefineTypes</text><polygon fill="#000000" points="2996,2968.7681,3006,2972.7681,2996,2976.7681,3000,2972.7681" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="2972.7681" y2="2972.7681"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="2968.4585">4.29</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="2968.4585"> </text><polygon fill="#000000" points="1524.5,2996.1367,1514.5,3000.1367,1524.5,3004.1367,1520.5,3000.1367" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1518.5" x2="3007" y1="3000.1367" y2="3000.1367"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1530.5" y="2995.8271">4.30</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="138" x="1562.5" y="2995.8271">DecomposeComplexOps</text><polygon fill="#000000" points="2996,3023.5054,3006,3027.5054,2996,3031.5054,3000,3027.5054" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1508.5" x2="3002" y1="3027.5054" y2="3027.5054"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1515.5" y="3023.1958">4.31</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1547.5" y="3023.1958"> </text><path d="M1513,3040.5054 L1513,3076.5054 L1690,3076.5054 L1690,3050.5054 L1680,3040.5054 L1513,3040.5054 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><path d="M1680,3040.5054 L1680,3050.5054 L1690,3050.5054 L1680,3040.5054 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="120" x="1519" y="3056.5645">对TorchDialect IR执行</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="156" x="1519" y="3069.9331">各种Pass优化(即Transforms)</text><polygon fill="#000000" points="699.5,3097.6113,689.5,3101.6113,699.5,3105.6113,695.5,3101.6113" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="693.5" x2="3012" y1="3101.6113" y2="3101.6113"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="705.5" y="3097.3018">4.32</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="737.5" y="3097.3018"> </text><polygon fill="#000000" points="265.5,3124.98,255.5,3128.98,265.5,3132.98,261.5,3128.98" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="259.5" x2="682.5" y1="3128.98" y2="3128.98"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="271.5" y="3124.6704">4.33</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="303.5" y="3124.6704"> </text><rect fill="#2A86E2" height="101" style="stroke:#181818;stroke-width:0.5;" width="406" x="51" y="3141.98"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="265" x="55" y="3157.0391">5. 将TorchDialect IR降低到Linalg-on-Tensors IR</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="308" x="55" y="3170.4077">if output_type == OutputType.LINALG_ON_TENSORS:</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="185" x="71" y="3183.7764">run_pipeline_with_repro_report(</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="68" x="87" y="3197.145">mb.module,</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="315" x="87" y="3210.5137">"torch-backend-to-linalg-on-tensors-backend-pipeline",</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="366" x="87" y="3223.8823">"Lowering Torch Backend IR -&gt; Linalg-on-Tensors Backend IR")</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="303" x="71" y="3237.251">return mb.module # 节选自torch_mlir.compile函数定义</text><polygon fill="#000000" points="666.5,3290.6665,676.5,3294.6665,666.5,3298.6665,670.5,3294.6665" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="254.5" x2="672.5" y1="3294.6665" y2="3294.6665"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="261.5" y="3276.9883">5.1</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="381" x="285.5" y="3263.6196">def run_pipeline_with_repro_report(module, pipeline, description):</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="200" x="317.5" y="3276.9883">pm = PassManager.parse(pipeline)</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="93" x="317.5" y="3290.3569">pm.run(module)</text><polygon fill="#000000" points="2996,3318.0352,3006,3322.0352,2996,3326.0352,3000,3322.0352" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="688.5" x2="3002" y1="3322.0352" y2="3322.0352"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="695.5" y="3317.7256">5.2</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="227" x="719.5" y="3317.7256">mlir::PassManager::run(Operation *op)</text><polygon fill="#000000" points="1655.5,3345.4038,1645.5,3349.4038,1655.5,3353.4038,1651.5,3349.4038" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1649.5" x2="3007" y1="3349.4038" y2="3349.4038"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1661.5" y="3345.0942">5.3</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="230" x="1685.5" y="3345.0942">VerifyInvariantsBeforeBackendLowering</text><polygon fill="#000000" points="2996,3372.7725,3006,3376.7725,2996,3380.7725,3000,3376.7725" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1639.5" x2="3002" y1="3376.7725" y2="3376.7725"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1646.5" y="3372.4629">5.4</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1670.5" y="3372.4629"> </text><polygon fill="#000000" points="1781,3400.1411,1771,3404.1411,1781,3408.1411,1777,3404.1411" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1775" x2="3007" y1="3404.1411" y2="3404.1411"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1787" y="3399.8315">5.5</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="146" x="1811" y="3399.8315">ConvertTorchToTMTensor</text><polygon fill="#000000" points="2996,3427.5098,3006,3431.5098,2996,3435.5098,3000,3431.5098" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1765" x2="3002" y1="3431.5098" y2="3431.5098"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1772" y="3427.2002">5.6</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1796" y="3427.2002"> </text><polygon fill="#000000" points="1781,3454.8784,1771,3458.8784,1781,3462.8784,1777,3458.8784" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1775" x2="3007" y1="3458.8784" y2="3458.8784"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1787" y="3454.5688">5.7</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="309" x="1811" y="3454.5688">ConvertTorchToLinalg，将TorchDialect转为LinalgDialect</text><line style="stroke:#000000;stroke-width:1.0;" x1="1770" x2="1812" y1="3486.2471" y2="3486.2471"/><line style="stroke:#000000;stroke-width:1.0;" x1="1812" x2="1812" y1="3486.2471" y2="3499.2471"/><line style="stroke:#000000;stroke-width:1.0;" x1="1771" x2="1812" y1="3499.2471" y2="3499.2471"/><polygon fill="#000000" points="1781,3495.2471,1771,3499.2471,1781,3503.2471,1777,3499.2471" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="32" x="1777" y="3481.9375">5.7.1</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="101" x="1813" y="3481.9375">runOnOperation()</text><polygon fill="#000000" points="2996,3602.8276,3006,3606.8276,2996,3610.8276,3000,3606.8276" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1770" x2="3002" y1="3606.8276" y2="3606.8276"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="32" x="1777" y="3562.4121">5.7.2</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="324" x="1813" y="3522.3062">ConversionTarget::addLegalDialect&lt;linalg::LinalgDialect,</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="234" x="1845" y="3535.6748">func::FuncDialect, cf::ControlFlowDialect,</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="239" x="1845" y="3549.0435">math::MathDialect, tensor::TensorDialect,</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="156" x="1845" y="3562.4121">arith::ArithmeticDialect&gt;();</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="178" x="1813" y="3575.7808">ConversionTarget::addLegalOp</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="230" x="1845" y="3589.1494">&lt;TorchConversion::GetNextSeedOp&gt;();</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="249" x="1813" y="3602.5181">指定TorchDialect作为Conversion的目标Dialect</text><line style="stroke:#000000;stroke-width:1.0;" x1="1770" x2="1812" y1="3674.3022" y2="3674.3022"/><line style="stroke:#000000;stroke-width:1.0;" x1="1812" x2="1812" y1="3674.3022" y2="3687.3022"/><line style="stroke:#000000;stroke-width:1.0;" x1="1771" x2="1812" y1="3687.3022" y2="3687.3022"/><polygon fill="#000000" points="1781,3683.3022,1771,3687.3022,1781,3691.3022,1777,3687.3022" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="32" x="1777" y="3649.9397">5.7.3</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="280" x="1813" y="3629.8867">populateXXX(populateLinearPatternsAndLegality/</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="208" x="1845" y="3643.2554">populatePoolingPatternsAndLegality/</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="214" x="1845" y="3656.624">populateRandomPatternsAndLegality/</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="240" x="1845" y="3669.9927">populateReductionPatternsAndLegality/...)</text><polygon fill="#000000" points="2996,3750.7769,3006,3754.7769,2996,3758.7769,3000,3754.7769" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1770" x2="3002" y1="3754.7769" y2="3754.7769"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="32" x="1777" y="3730.4143">5.7.4</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="198" x="1813" y="3710.3613">ConversionTarget::addIllegalOp();</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="143" x="1813" y="3723.73">RewritePatternSet.add();</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="167" x="1813" y="3737.0986">指定TorchDialect中的illegal Op</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="209" x="1813" y="3750.4673">并添加匹配这些Op的ConversionPattern</text><polygon fill="#000000" points="2996,3831.6201,3006,3835.6201,2996,3839.6201,3000,3835.6201" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1770" x2="3002" y1="3835.6201" y2="3835.6201"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="32" x="1777" y="3804.5732">5.7.5</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="224" x="1813" y="3777.8359">applyPartialConversion(getOperation(),</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="168" x="1845" y="3791.2046">target, std::move(patterns));</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="228" x="1813" y="3804.5732">使用MLIR提供Pattern Rewriting System对</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="204" x="1813" y="3817.9419">设置的illegal Op做Pattern匹配和重写，</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="92" x="1813" y="3831.3105">完成部分lowering</text><polygon fill="#000000" points="1781,3858.9888,1771,3862.9888,1781,3866.9888,1777,3862.9888" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1775" x2="3007" y1="3862.9888" y2="3862.9888"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="32" x="1787" y="3858.6792">5.7.6</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="107" x="1823" y="3858.6792">ConvertAtenMmOp</text><path d="M1775,3875.9888 L1775,3911.9888 L2482,3911.9888 L2482,3885.9888 L2472,3875.9888 L1775,3875.9888 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><path d="M2472,3875.9888 L2472,3885.9888 L2482,3885.9888 L2472,3875.9888 " fill="#00FFFF" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="318" x="1781" y="3892.0479">匹配到torch.aten.mm Op会被rewrite为Linalg中的MamulOp</text><text fill="#000000" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="686" x="1781" y="3905.4165">%9 = linalg.matmul ins(%0, %1: tensor&lt;?x?xf32&gt;, tensor&lt;?x?xf32&gt;) outs(%8: tensor&lt;?x?xf32&gt;) -&gt; tensor&lt;?x?xf32&gt;</text><polygon fill="#000000" points="1781,4013.3066,1771,4017.3066,1781,4021.3066,1777,4017.3066" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1775" x2="3007" y1="4017.3066" y2="4017.3066"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="32" x="1787" y="3972.8911">5.7.7</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="112" x="1823" y="3932.7852">ConvertXXXOp(如：</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="127" x="1855" y="3946.1538">ConvertAtenLinearOp/</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="159" x="1855" y="3959.5225">ConvertAtenConvolutionOp/</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="153" x="1855" y="3972.8911">ConvertAtenMaxPool2dOp/</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="169" x="1855" y="3986.2598">ConvertAtenAvgPool2dOp/...)</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="200" x="1823" y="3999.6284">匹配TorchDialect中的其他illegal Op，</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="115" x="1823" y="4012.9971">并重写为Linalg中的Op</text><polygon fill="#000000" points="2996,4040.6753,3006,4044.6753,2996,4048.6753,3000,4044.6753" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1765" x2="3002" y1="4044.6753" y2="4044.6753"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1772" y="4040.3657">5.8</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1796" y="4040.3657"> </text><polygon fill="#000000" points="1781,4068.0439,1771,4072.0439,1781,4076.0439,1777,4072.0439" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1775" x2="3007" y1="4072.0439" y2="4072.0439"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="20" x="1787" y="4067.7344">5.9</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="113" x="1811" y="4067.7344">ConvertTorchToSCF</text><polygon fill="#000000" points="2996,4095.4126,3006,4099.4126,2996,4103.4126,3000,4099.4126" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1765" x2="3002" y1="4099.4126" y2="4099.4126"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1772" y="4095.103">5.10</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1804" y="4095.103"> </text><polygon fill="#000000" points="1781,4122.7813,1771,4126.7813,1781,4130.7813,1777,4126.7813" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1775" x2="3007" y1="4126.7813" y2="4126.7813"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1787" y="4122.4717">5.11</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="110" x="1819" y="4122.4717">ConvertTorchToStd</text><polygon fill="#000000" points="2996,4150.1499,3006,4154.1499,2996,4158.1499,3000,4154.1499" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1765" x2="3002" y1="4154.1499" y2="4154.1499"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1772" y="4149.8403">5.12</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1804" y="4149.8403"> </text><line style="stroke:#000000;stroke-width:1.0;" x1="3018" x2="3060" y1="4181.5186" y2="4181.5186"/><line style="stroke:#000000;stroke-width:1.0;" x1="3060" x2="3060" y1="4181.5186" y2="4194.5186"/><line style="stroke:#000000;stroke-width:1.0;" x1="3019" x2="3060" y1="4194.5186" y2="4194.5186"/><polygon fill="#000000" points="3029,4190.5186,3019,4194.5186,3029,4198.5186,3025,4194.5186" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="3025" y="4177.209">5.13</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="151" x="3057" y="4177.209">mlir::memref::ExpandOps</text><line style="stroke:#000000;stroke-width:1.0;" x1="3018" x2="3060" y1="4221.8872" y2="4221.8872"/><line style="stroke:#000000;stroke-width:1.0;" x1="3060" x2="3060" y1="4221.8872" y2="4234.8872"/><line style="stroke:#000000;stroke-width:1.0;" x1="3019" x2="3060" y1="4234.8872" y2="4234.8872"/><polygon fill="#000000" points="3029,4230.8872,3019,4234.8872,3029,4238.8872,3025,4234.8872" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="3025" y="4217.5776">5.14</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="76" x="3057" y="4217.5776">Canonicalizer</text><line style="stroke:#000000;stroke-width:1.0;" x1="3018" x2="3060" y1="4275.6245" y2="4275.6245"/><line style="stroke:#000000;stroke-width:1.0;" x1="3060" x2="3060" y1="4275.6245" y2="4288.6245"/><line style="stroke:#000000;stroke-width:1.0;" x1="3019" x2="3060" y1="4288.6245" y2="4288.6245"/><polygon fill="#000000" points="3029,4284.6245,3019,4288.6245,3029,4292.6245,3025,4288.6245" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="3025" y="4264.6306">5.15</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="87" x="3057" y="4257.9463">mlir::memref::</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="179" x="3057" y="4271.3149">ResolveShapedTypeResultDims</text><line style="stroke:#000000;stroke-width:1.0;" x1="3018" x2="3060" y1="4315.9932" y2="4315.9932"/><line style="stroke:#000000;stroke-width:1.0;" x1="3060" x2="3060" y1="4315.9932" y2="4328.9932"/><line style="stroke:#000000;stroke-width:1.0;" x1="3019" x2="3060" y1="4328.9932" y2="4328.9932"/><polygon fill="#000000" points="3029,4324.9932,3019,4328.9932,3029,4332.9932,3025,4328.9932" style="stroke:#000000;stroke-width:1.0;"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="3025" y="4311.6836">5.16</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="23" x="3057" y="4311.6836">CSE</text><polygon fill="#000000" points="1655.5,4352.3618,1645.5,4356.3618,1655.5,4360.3618,1651.5,4356.3618" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1649.5" x2="3007" y1="4356.3618" y2="4356.3618"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1661.5" y="4352.0522">5.17</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="167" x="1693.5" y="4352.0522">FuncBackendTypeConversion</text><polygon fill="#000000" points="2996,4379.7305,3006,4383.7305,2996,4387.7305,3000,4383.7305" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1639.5" x2="3002" y1="4383.7305" y2="4383.7305"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1646.5" y="4379.4209">5.18</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1678.5" y="4379.4209"> </text><polygon fill="#000000" points="1655.5,4407.0991,1645.5,4411.0991,1655.5,4415.0991,1651.5,4411.0991" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1649.5" x2="3007" y1="4411.0991" y2="4411.0991"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1661.5" y="4406.7896">5.19</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="193" x="1693.5" y="4406.7896">FinalizingBackendTypeConversion</text><polygon fill="#000000" points="2996,4434.4678,3006,4438.4678,2996,4442.4678,3000,4438.4678" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1639.5" x2="3002" y1="4438.4678" y2="4438.4678"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1646.5" y="4434.1582">5.20</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1678.5" y="4434.1582"> </text><polygon fill="#000000" points="1655.5,4461.8364,1645.5,4465.8364,1655.5,4469.8364,1651.5,4465.8364" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1649.5" x2="3007" y1="4465.8364" y2="4465.8364"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1661.5" y="4461.5269">5.21</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="251" x="1693.5" y="4461.5269">VerifyLinalgOnTensorsBackendContractPass</text><polygon fill="#000000" points="2996,4489.2051,3006,4493.2051,2996,4497.2051,3000,4493.2051" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1639.5" x2="3002" y1="4493.2051" y2="4493.2051"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="1646.5" y="4488.8955">5.22</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="1678.5" y="4488.8955"> </text><polygon fill="#000000" points="699.5,4516.5737,689.5,4520.5737,699.5,4524.5737,695.5,4520.5737" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="693.5" x2="3012" y1="4520.5737" y2="4520.5737"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="705.5" y="4516.2642">5.23</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="737.5" y="4516.2642"> </text><polygon fill="#000000" points="265.5,4543.9424,255.5,4547.9424,265.5,4551.9424,261.5,4547.9424" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="259.5" x2="682.5" y1="4547.9424" y2="4547.9424"/><text fill="#333333" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="28" x="271.5" y="4543.6328">5.24</text><text fill="#333333" font-family="Verdana" font-size="11" lengthAdjust="spacing" textLength="4" x="303.5" y="4543.6328"> </text><!--MD5=[05d43f801b1f35b83bf621251eb286ab]
@startuml torch_mlir
!theme reddress-lightblue

' title torch-mlir Sequence Diagram

actor Python as python
participant "pybind11" as pybind11
participant "CAPI" as capi
participant "InitAll" as init
participant "Dialect/Torch" as dialectTorch
participant "Dialect/TorchConversion" as dialectConversion
participant "Conversion" as conversion
participant "RefBackend" as backend
participant "externals/torch-mlir-dialects" as tmd
participant "ModuleBuilder" as builder
participant "IValueImporter" as ivImporter
participant "NodeImporter" as nodeImporter
participant "MLIR" as mlir
' https://github.com/llvm/torch-mlir/blob/main/python/torch_mlir/__init__.py#L122
' https://github.com/llvm/llvm-project/blob/main/mlir/lib/Bindings/Python/Pass.cpp#L58
rnote over python
  1. 注册与torch相关的MLIR转换和优化Pass
  import torch
  import torch_mlir
  class TanhModule(torch.nn.Module):
    def forward(self, a):
        return torch.tanh(a)
  compiled = torch_mlir.compile(TanhModule(), torch.ones(3),
        output_type=torch_mlir.OutputType.LINALG_ON_TENSORS)
endrnote

autonumber 1.1
python->pybind11:PYBIND11_MODULE(_torchMlir, m)
activate pybind11
pybind11->capi:torchMlirRegisterAllPasses()
activate capi
capi->init:mlir::torch::registerAllPasses()\n注册与torch相关的MLIR转换和优化Pass
activate init
init->dialectTorch:mlir::torch::registerTorchPasses()\n注册优化TorchDialect IR的Pass
activate dialectTorch
dialectTorch- ->init
deactivate dialectTorch
init->dialectConversion:mlir::torch::registerTorchConversionPasses()\n注册把TorchDialect Convert为LinalgDialect的Pass
activate dialectConversion
dialectConversion- ->init
deactivate dialectConversion
init->conversion:mlir::torch::registerConversionPasses()
activate conversion
conversion- ->init
deactivate conversion
init->backend:mlir::torch::RefBackend::registerRefBackendPasses()
activate backend
backend- ->init
deactivate backend
init->tmd:mlir::torch::TMTensor::registerPasses()
activate tmd
tmd- ->init
deactivate tmd
init- ->capi
deactivate init
capi- ->pybind11
deactivate capi
pybind11- ->python
deactivate pybind11

autonumber inc A
rnote over python
  2. 注册torch-mlir使用到的所有Dialects
  from torch_mlir.dialects.torch.importer.jit_ir import ModuleBuilder
  mb = ModuleBuilder() # 节选自torch_mlir.compile函数定义
endrnote

python->pybind11
activate pybind11
pybind11->builder:创建ModuleBuilder类型对象
activate builder
builder->capi:torchMlirRegisterAllDialects(context)
activate capi
capi->init:mlir::torch::registerAllDialects(registry)\n注册如下Dialects：\nmlir::torch::Torch::TorchDialect\nmlir::torch::TorchConversion::TorchConversionDialect\nmlir::torch::TMTensor::TMTensorDialect

note right of dialectTorch #aqua
def Torch_AtenTanhOp : Torch_Op<"aten.tanh", [
    AllowsTypeRefinement,
    HasValueSemantics,
    ReadOnly
  ]> {
  let summary = "Generated op for `aten::tanh : (Tensor) -> (Tensor)`";
  let arguments = (ins
    AnyTorchTensorType:$self
  );
  let results = (outs
    AnyTorchTensorType:$result
  );
  let hasCustomAssemblyFormat = 1;
  let extraClassDefinition = [{
    ParseResult AtenTanhOp::parse(OpAsmParser &parser, OperationState &result) {
      return parseDefaultTorchOp(parser, result, 1, 1);
    }
    void AtenTanhOp::print(OpAsmPrinter &printer) {
      printDefaultTorchOp(printer, *this, 1, 1);
    }
  }];
}
end note

activate init
note right of init #aqua
注册TorchDialect/TorchConversionDialect/TMTensorDialect
TorchDialect中的Op定义已经通过torch_ods_gen.py生成到
GeneratedTorchOps.td文件中
end note
init- ->capi
deactivate init
capi- ->builder
deactivate capi
builder- ->pybind11
deactivate builder
pybind11- ->python
deactivate pybind11

autonumber inc A
rnote over python
  3. 将torchscript IR转换为TorchDialect IR
  mb.import_module(scripted._c, class_annotator) # 节选自torch_mlir.compile函数定义
endrnote

python->pybind11:import_module()
activate pybind11
pybind11->builder:importModule()\n变量torchscript IR并创建对应的TorchDialect Op
activate builder

note right of builder #aqua
举例，torchscript IR节点：
%1: Float(3:4, 4:1) = aten::mm(%4, %2, %3)
end note

builder->ivImporter:importIValue()
activate ivImporter
ivImporter->mlir:IValueImporter::importIValue调用\nIValueImporter::rawImportIValue，\n接着调用createMlirOperation和\ncreateMlirOperationAtEnd\n以创建对应的TorchDialect Op
activate mlir
mlir- ->ivImporter
deactivate mlir
ivImporter->nodeImporter:IValueImporter::importIValue调用\nIValueImporter::rawImportIValue，\n接着调用IValueImporter::importModule，\n再调用importCompilationUnit，\n接着调用importJitFunctionAsFuncOp，\n最后调用importBlock，即进入NodeImporter
activate nodeImporter
nodeImporter->mlir:调用createMlirOperation和\ncreateMlirOperationAtEnd\n创建对应的TorchDialect Op
activate mlir

note right of nodeImporter #aqua
转换为TorchDialect IR，对应的Op：
%1 = torch.aten.mm %arg0, %arg1:
!torch.vtensor<[?,?], f32>, !torch.vtensor<[?,?], f32>
-> !torch.vtensor<[?,2], f32> 
end note

mlir- ->nodeImporter
deactivate mlir
nodeImporter- ->ivImporter
deactivate nodeImporter
ivImporter- ->builder
deactivate ivImporter
builder- ->pybind11
deactivate builder
pybind11- ->python
deactivate pybind11

rnote over python
  4. 对TorchDialect IR执行各种Pass优化(即Transforms)
  run_pipeline_with_repro_report(mb.module,
      "torchscript-module-to-torch-backend-pipeline",
      "Lowering TorchScript IR -> Torch Backend IR") # 节选自torch_mlir.compile函数定义
endrnote

autonumber inc A
python->pybind11: def run_pipeline_with_repro_report(module, pipeline, description):\n\tpm = PassManager.parse(pipeline)\n\tpm.run(module)
activate pybind11
pybind11->mlir:mlir::PassManager::run(Operation *op)
activate mlir
mlir->mlir:SymbolDCE
mlir->dialectTorch:PrepareForGlobalizeObjectGraph
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:GlobalizeObjectGraph
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->mlir:Inliner
mlir->dialectTorch:AdjustCallingConventions
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->mlir:Canonicalizer
mlir->dialectTorch:InlineGlobalSlots
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:ReduceOpVariants
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:MaximizeValueSemantics
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:RefinePublicReturn
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:VerifyConversionToValueSemantics
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:ReifyShapeCalculations
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:SimplifyShapeCalculations
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:DropShapeCalculations
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:RefineTypes
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:DecomposeComplexOps
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch

note right of dialectTorch #aqua
对TorchDialect IR执行
各种Pass优化(即Transforms)
end note

mlir- ->pybind11
deactivate mlir
pybind11- ->python
deactivate pybind11


rnote over python
  5. 将TorchDialect IR降低到Linalg-on-Tensors IR
  if output_type == OutputType.LINALG_ON_TENSORS:
      run_pipeline_with_repro_report(
          mb.module,
          "torch-backend-to-linalg-on-tensors-backend-pipeline",
          "Lowering Torch Backend IR -> Linalg-on-Tensors Backend IR")
      return mb.module # 节选自torch_mlir.compile函数定义
endrnote

autonumber inc A
python->pybind11: def run_pipeline_with_repro_report(module, pipeline, description):\n\tpm = PassManager.parse(pipeline)\n\tpm.run(module)
activate pybind11
pybind11->mlir:mlir::PassManager::run(Operation *op)
activate mlir
mlir->dialectConversion:VerifyInvariantsBeforeBackendLowering
activate dialectConversion
dialectConversion- ->mlir
deactivate dialectConversion
mlir->conversion:ConvertTorchToTMTensor
activate conversion
conversion- ->mlir
deactivate conversion
mlir->conversion:ConvertTorchToLinalg，将TorchDialect转为LinalgDialect
activate conversion

' autonumber stop
autonumber 5.7.1
conversion->conversion:runOnOperation()
conversion->mlir:ConversionTarget::addLegalDialect<linalg::LinalgDialect, \n\tfunc::FuncDialect, cf::ControlFlowDialect, \n\tmath::MathDialect, tensor::TensorDialect,\n\tarith::ArithmeticDialect>();\nConversionTarget::addLegalOp\n\t<TorchConversion::GetNextSeedOp>();\n指定TorchDialect作为Conversion的目标Dialect
conversion->conversion:populateXXX(populateLinearPatternsAndLegality/\n\tpopulatePoolingPatternsAndLegality/\n\tpopulateRandomPatternsAndLegality/\n\tpopulateReductionPatternsAndLegality/...)
conversion->mlir:ConversionTarget::addIllegalOp();\nRewritePatternSet.add();\n指定TorchDialect中的illegal Op\n并添加匹配这些Op的ConversionPattern
conversion->mlir:applyPartialConversion(getOperation(),\n\ttarget, std::move(patterns));\n使用MLIR提供Pattern Rewriting System对\n设置的illegal Op做Pattern匹配和重写，\n完成部分lowering
mlir->conversion:ConvertAtenMmOp

note right of conversion #aqua
匹配到torch.aten.mm Op会被rewrite为Linalg中的MamulOp
%9 = linalg.matmul ins(%0, %1: tensor<?x?xf32>, tensor<?x?xf32>) outs(%8: tensor<?x?xf32>) -> tensor<?x?xf32>
end note

mlir->conversion:ConvertXXXOp(如：\n\tConvertAtenLinearOp/\n\tConvertAtenConvolutionOp/\n\tConvertAtenMaxPool2dOp/\n\tConvertAtenAvgPool2dOp/...)\n匹配TorchDialect中的其他illegal Op，\n并重写为Linalg中的Op

' autonumber resume
autonumber 5.8
conversion- ->mlir
deactivate conversion
mlir->conversion:ConvertTorchToSCF
activate conversion
conversion- ->mlir
deactivate conversion
mlir->conversion:ConvertTorchToStd
activate conversion
conversion- ->mlir
deactivate conversion
mlir->mlir:mlir::memref::ExpandOps
mlir->mlir:Canonicalizer
mlir->mlir:mlir::memref::\nResolveShapedTypeResultDims
mlir->mlir:CSE
mlir->dialectConversion:FuncBackendTypeConversion
activate dialectConversion
dialectConversion- ->mlir
deactivate dialectConversion
mlir->dialectConversion:FinalizingBackendTypeConversion
activate dialectConversion
dialectConversion- ->mlir
deactivate dialectConversion
mlir->dialectConversion:VerifyLinalgOnTensorsBackendContractPass
activate dialectConversion
dialectConversion- ->mlir
deactivate dialectConversion
mlir- ->pybind11
deactivate mlir
pybind11- ->python
deactivate pybind11
@enduml

@startuml torch_mlir



skinparam stereotypeCBackgroundColor 1a66c2
skinparam backgroundColor fff







skinparam circledCharacter {
  radius 8
  fontSize 11
  fontName Verdana
}

skinparam class {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Verdana
  arrowFontColor 333
  arrowFontSize 11

  attributeFontColor 333
  attributeFontSize 11
  attributeIconSize 11
}


skinparam actor {
    backgroundColor 2a86e2
  borderColor 1a66c2
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam participant {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam collections {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam SequenceBox{
    backgroundColor e0e0e0
  borderColor cccccc
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}


skinparam interface {
    backgroundColor 2a86e2
  borderColor 1a66c2
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam component {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam node {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam database {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam queue {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}


skinparam usecase {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Verdana
  arrowFontColor 333
  arrowFontSize 11
}

skinparam activity {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Verdana
  arrowFontColor 333
  arrowFontSize 11
}

skinparam sequence {
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Verdana
  arrowFontColor 333
  arrowFontSize 11

  lifeLineBorderColor 2a86e2
  lifeLineBackgroundColor e0e0e0
}

skinparam boundary {
    backgroundColor 2a86e2
  borderColor 1a66c2
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam control {
    backgroundColor 2a86e2
  borderColor 1a66c2
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam entity {
    backgroundColor 2a86e2
  borderColor 1a66c2
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}


skinparam state {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Verdana
  arrowFontColor 333
  arrowFontSize 11
  startColor 2a86e2
  endColor 1a66c2
}


skinparam object {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Verdana
  arrowFontColor 333
  arrowFontSize 11
}


skinparam note {
    backgroundColor 2a86e2
  borderColor 1a66c2
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam cloud {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
    arrowColor 000
  arrowFontName Verdana
  arrowFontColor 333
  arrowFontSize 11
}

skinparam rectangle {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}

skinparam storage {
    backgroundColor ccc
  borderColor aaa
    fontColor 000
  fontName Verdana
  fontSize 11
  stereotypeFontColor 333
  stereotypeFontSize 11
}


actor Python as python
participant "pybind11" as pybind11
participant "CAPI" as capi
participant "InitAll" as init
participant "Dialect/Torch" as dialectTorch
participant "Dialect/TorchConversion" as dialectConversion
participant "Conversion" as conversion
participant "RefBackend" as backend
participant "externals/torch-mlir-dialects" as tmd
participant "ModuleBuilder" as builder
participant "IValueImporter" as ivImporter
participant "NodeImporter" as nodeImporter
participant "MLIR" as mlir
rnote over python
  1. 注册与torch相关的MLIR转换和优化Pass
  import torch
  import torch_mlir
  class TanhModule(torch.nn.Module):
    def forward(self, a):
        return torch.tanh(a)
  compiled = torch_mlir.compile(TanhModule(), torch.ones(3),
        output_type=torch_mlir.OutputType.LINALG_ON_TENSORS)
endrnote

autonumber 1.1
python->pybind11:PYBIND11_MODULE(_torchMlir, m)
activate pybind11
pybind11->capi:torchMlirRegisterAllPasses()
activate capi
capi->init:mlir::torch::registerAllPasses()\n注册与torch相关的MLIR转换和优化Pass
activate init
init->dialectTorch:mlir::torch::registerTorchPasses()\n注册优化TorchDialect IR的Pass
activate dialectTorch
dialectTorch- ->init
deactivate dialectTorch
init->dialectConversion:mlir::torch::registerTorchConversionPasses()\n注册把TorchDialect Convert为LinalgDialect的Pass
activate dialectConversion
dialectConversion- ->init
deactivate dialectConversion
init->conversion:mlir::torch::registerConversionPasses()
activate conversion
conversion- ->init
deactivate conversion
init->backend:mlir::torch::RefBackend::registerRefBackendPasses()
activate backend
backend- ->init
deactivate backend
init->tmd:mlir::torch::TMTensor::registerPasses()
activate tmd
tmd- ->init
deactivate tmd
init- ->capi
deactivate init
capi- ->pybind11
deactivate capi
pybind11- ->python
deactivate pybind11

autonumber inc A
rnote over python
  2. 注册torch-mlir使用到的所有Dialects
  from torch_mlir.dialects.torch.importer.jit_ir import ModuleBuilder
  mb = ModuleBuilder() # 节选自torch_mlir.compile函数定义
endrnote

python->pybind11
activate pybind11
pybind11->builder:创建ModuleBuilder类型对象
activate builder
builder->capi:torchMlirRegisterAllDialects(context)
activate capi
capi->init:mlir::torch::registerAllDialects(registry)\n注册如下Dialects：\nmlir::torch::Torch::TorchDialect\nmlir::torch::TorchConversion::TorchConversionDialect\nmlir::torch::TMTensor::TMTensorDialect

note right of dialectTorch #aqua
def Torch_AtenTanhOp : Torch_Op<"aten.tanh", [
    AllowsTypeRefinement,
    HasValueSemantics,
    ReadOnly
  ]> {
  let summary = "Generated op for `aten::tanh : (Tensor) -> (Tensor)`";
  let arguments = (ins
    AnyTorchTensorType:$self
  );
  let results = (outs
    AnyTorchTensorType:$result
  );
  let hasCustomAssemblyFormat = 1;
  let extraClassDefinition = [{
    ParseResult AtenTanhOp::parse(OpAsmParser &parser, OperationState &result) {
      return parseDefaultTorchOp(parser, result, 1, 1);
    }
    void AtenTanhOp::print(OpAsmPrinter &printer) {
      printDefaultTorchOp(printer, *this, 1, 1);
    }
  }];
}
end note

activate init
note right of init #aqua
注册TorchDialect/TorchConversionDialect/TMTensorDialect
TorchDialect中的Op定义已经通过torch_ods_gen.py生成到
GeneratedTorchOps.td文件中
end note
init- ->capi
deactivate init
capi- ->builder
deactivate capi
builder- ->pybind11
deactivate builder
pybind11- ->python
deactivate pybind11

autonumber inc A
rnote over python
  3. 将torchscript IR转换为TorchDialect IR
  mb.import_module(scripted._c, class_annotator) # 节选自torch_mlir.compile函数定义
endrnote

python->pybind11:import_module()
activate pybind11
pybind11->builder:importModule()\n变量torchscript IR并创建对应的TorchDialect Op
activate builder

note right of builder #aqua
举例，torchscript IR节点：
%1: Float(3:4, 4:1) = aten::mm(%4, %2, %3)
end note

builder->ivImporter:importIValue()
activate ivImporter
ivImporter->mlir:IValueImporter::importIValue调用\nIValueImporter::rawImportIValue，\n接着调用createMlirOperation和\ncreateMlirOperationAtEnd\n以创建对应的TorchDialect Op
activate mlir
mlir- ->ivImporter
deactivate mlir
ivImporter->nodeImporter:IValueImporter::importIValue调用\nIValueImporter::rawImportIValue，\n接着调用IValueImporter::importModule，\n再调用importCompilationUnit，\n接着调用importJitFunctionAsFuncOp，\n最后调用importBlock，即进入NodeImporter
activate nodeImporter
nodeImporter->mlir:调用createMlirOperation和\ncreateMlirOperationAtEnd\n创建对应的TorchDialect Op
activate mlir

note right of nodeImporter #aqua
转换为TorchDialect IR，对应的Op：
%1 = torch.aten.mm %arg0, %arg1:
!torch.vtensor<[?,?], f32>, !torch.vtensor<[?,?], f32>
-> !torch.vtensor<[?,2], f32> 
end note

mlir- ->nodeImporter
deactivate mlir
nodeImporter- ->ivImporter
deactivate nodeImporter
ivImporter- ->builder
deactivate ivImporter
builder- ->pybind11
deactivate builder
pybind11- ->python
deactivate pybind11

rnote over python
  4. 对TorchDialect IR执行各种Pass优化(即Transforms)
  run_pipeline_with_repro_report(mb.module,
      "torchscript-module-to-torch-backend-pipeline",
      "Lowering TorchScript IR -> Torch Backend IR") # 节选自torch_mlir.compile函数定义
endrnote

autonumber inc A
python->pybind11: def run_pipeline_with_repro_report(module, pipeline, description):\n\tpm = PassManager.parse(pipeline)\n\tpm.run(module)
activate pybind11
pybind11->mlir:mlir::PassManager::run(Operation *op)
activate mlir
mlir->mlir:SymbolDCE
mlir->dialectTorch:PrepareForGlobalizeObjectGraph
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:GlobalizeObjectGraph
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->mlir:Inliner
mlir->dialectTorch:AdjustCallingConventions
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->mlir:Canonicalizer
mlir->dialectTorch:InlineGlobalSlots
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:ReduceOpVariants
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:MaximizeValueSemantics
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:RefinePublicReturn
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:VerifyConversionToValueSemantics
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:ReifyShapeCalculations
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:SimplifyShapeCalculations
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:DropShapeCalculations
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:RefineTypes
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch
mlir->dialectTorch:DecomposeComplexOps
activate dialectTorch
dialectTorch- ->mlir
deactivate dialectTorch

note right of dialectTorch #aqua
对TorchDialect IR执行
各种Pass优化(即Transforms)
end note

mlir- ->pybind11
deactivate mlir
pybind11- ->python
deactivate pybind11


rnote over python
  5. 将TorchDialect IR降低到Linalg-on-Tensors IR
  if output_type == OutputType.LINALG_ON_TENSORS:
      run_pipeline_with_repro_report(
          mb.module,
          "torch-backend-to-linalg-on-tensors-backend-pipeline",
          "Lowering Torch Backend IR -> Linalg-on-Tensors Backend IR")
      return mb.module # 节选自torch_mlir.compile函数定义
endrnote

autonumber inc A
python->pybind11: def run_pipeline_with_repro_report(module, pipeline, description):\n\tpm = PassManager.parse(pipeline)\n\tpm.run(module)
activate pybind11
pybind11->mlir:mlir::PassManager::run(Operation *op)
activate mlir
mlir->dialectConversion:VerifyInvariantsBeforeBackendLowering
activate dialectConversion
dialectConversion- ->mlir
deactivate dialectConversion
mlir->conversion:ConvertTorchToTMTensor
activate conversion
conversion- ->mlir
deactivate conversion
mlir->conversion:ConvertTorchToLinalg，将TorchDialect转为LinalgDialect
activate conversion

autonumber 5.7.1
conversion->conversion:runOnOperation()
conversion->mlir:ConversionTarget::addLegalDialect<linalg::LinalgDialect, \n\tfunc::FuncDialect, cf::ControlFlowDialect, \n\tmath::MathDialect, tensor::TensorDialect,\n\tarith::ArithmeticDialect>();\nConversionTarget::addLegalOp\n\t<TorchConversion::GetNextSeedOp>();\n指定TorchDialect作为Conversion的目标Dialect
conversion->conversion:populateXXX(populateLinearPatternsAndLegality/\n\tpopulatePoolingPatternsAndLegality/\n\tpopulateRandomPatternsAndLegality/\n\tpopulateReductionPatternsAndLegality/...)
conversion->mlir:ConversionTarget::addIllegalOp();\nRewritePatternSet.add();\n指定TorchDialect中的illegal Op\n并添加匹配这些Op的ConversionPattern
conversion->mlir:applyPartialConversion(getOperation(),\n\ttarget, std::move(patterns));\n使用MLIR提供Pattern Rewriting System对\n设置的illegal Op做Pattern匹配和重写，\n完成部分lowering
mlir->conversion:ConvertAtenMmOp

note right of conversion #aqua
匹配到torch.aten.mm Op会被rewrite为Linalg中的MamulOp
%9 = linalg.matmul ins(%0, %1: tensor<?x?xf32>, tensor<?x?xf32>) outs(%8: tensor<?x?xf32>) -> tensor<?x?xf32>
end note

mlir->conversion:ConvertXXXOp(如：\n\tConvertAtenLinearOp/\n\tConvertAtenConvolutionOp/\n\tConvertAtenMaxPool2dOp/\n\tConvertAtenAvgPool2dOp/...)\n匹配TorchDialect中的其他illegal Op，\n并重写为Linalg中的Op

autonumber 5.8
conversion- ->mlir
deactivate conversion
mlir->conversion:ConvertTorchToSCF
activate conversion
conversion- ->mlir
deactivate conversion
mlir->conversion:ConvertTorchToStd
activate conversion
conversion- ->mlir
deactivate conversion
mlir->mlir:mlir::memref::ExpandOps
mlir->mlir:Canonicalizer
mlir->mlir:mlir::memref::\nResolveShapedTypeResultDims
mlir->mlir:CSE
mlir->dialectConversion:FuncBackendTypeConversion
activate dialectConversion
dialectConversion- ->mlir
deactivate dialectConversion
mlir->dialectConversion:FinalizingBackendTypeConversion
activate dialectConversion
dialectConversion- ->mlir
deactivate dialectConversion
mlir->dialectConversion:VerifyLinalgOnTensorsBackendContractPass
activate dialectConversion
dialectConversion- ->mlir
deactivate dialectConversion
mlir- ->pybind11
deactivate mlir
pybind11- ->python
deactivate pybind11
@enduml

PlantUML version 1.2022.5(Sat Apr 30 18:55:52 CST 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg>